#!/bin/bash -ie

if [ -z "$SECRETS_BUCKET" ]; then
  echo "SECRETS_BUCKET is not specified"
  exit 1
fi

if [ -z "$SECRETS_PREFIX" ]; then
  echo "SECRETS_PREFIX is not specified"
  exit 1
fi

if [ -z "$SECRETS_KEY" ]; then
  echo "SECRETS_KEY is not specified"
  exit 1
fi

upload() {
  local key=$1
  AWS_ACCESS_KEY_ID="$TF_VAR_access_key"
  AWS_SECRET_ACCESS_KEY="$TF_VAR_secret_key"
  AWS_DEFAULT_REGION="$TF_VAR_region"
  aws s3 cp --acl private --sse-c --sse-c-key "$SECRETS_KEY" - "s3://${SECRETS_BUCKET}/${SECRETS_PREFIX}/${key}"
}

add_hosts() {
  for host in github.com bastion.everydayhero.io bastion.everydayhero-staging.io; do
    echo "[[ -f ~/.ssh/known_hosts ]] && ssh-keygen -R $host"
    echo "ssh-keyscan -t rsa $host >> ~/.ssh/known_hosts"
  done
}

docker_auth() {
  local docker_hub_auth=$(echo "${DOCKER_HUB_USER}:${DOCKER_HUB_PASSWORD}" | base64)
  local quay_auth=$(echo "${QUAY_USER}:${QUAY_PASSWORD}" | base64)

  cat <<AUTH
export DOCKER_AUTH='{"auths":{"https://index.docker.io/v1/":{"auth":"${docker_hub_auth}","email":"${DOCKER_HUB_EMAIL}"},"quay.io":{"email":"${QUAY_EMAIL}","auth":"${quay_auth}"}}}'
AUTH
}

configure_plain() {
  cat <<EOT
mkdir -p ~/Code

for repo in configure plain-utils ; do
  if [ -d "\$code/\$repo" ] ; then
    cd "\$code/\$repo" && git fetch origin master
  else
    cd "\$code" && git clone "git@github.com:everydayhero/\${repo}.git"
  fi
done

export PATH="\$code/plain-utils/bin:\$PATH"
EOT
}

echo "~~~ Uploading id_rsa"
if [ -f ~/.ssh/deployer ]; then
  cat ~/.ssh/deployer | upload "id_rsa"
elif [ -f ~/.ssh/id_rsa ]; then
  cat ~/.ssh/id_rsa | upload "id_rsa"
fi

echo "~~~ Uploading env"
cat <<ENV | upload "env"
$(add_hosts)
$(docker_auth)
$(configure_plain)
ENV
