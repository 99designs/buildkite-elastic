Resources:
  MissingMetricsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      MetricName: ScheduledJobsCount
      Namespace: Buildkite
      Statistic: SampleCount
      Period: 300
      EvaluationPeriods: 1
      Threshold: 0
      Dimensions:
        - Name: Queue
          Value: !Ref BuildkiteQueue
      ComparisonOperator: LessThanOrEqualToThreshold

  AgentScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref AgentAutoScaleGroup
      Cooldown: 120
      ScalingAdjustment : !Ref ScaleUpAdjustment

  AgentScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref AgentAutoScaleGroup
      Cooldown : 60
      ScalingAdjustment: !Ref ScaleDownAdjustment

  AgentUtilizationAlarmHigh:
   Type: AWS::CloudWatch::Alarm
   Properties:
      AlarmDescription: Scale-up if ScheduledJobs > 0 for 1 minute
      MetricName: ScheduledJobsCount
      Namespace: Buildkite
      Statistic: Minimum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 0
      AlarmActions: [ !Ref AgentScaleUpPolicy ]
      Dimensions:
        - Name: Queue
          Value: !Ref BuildkiteQueue
      ComparisonOperator: GreaterThanThreshold

  AgentUtilizationAlarmLow:
   Type: AWS::CloudWatch::Alarm
   Properties:
      AlarmDescription: Scale-down if UnfinishedJobs == 0 for 30 minutes
      MetricName: UnfinishedJobsCount
      Namespace: Buildkite
      Statistic: Maximum
      Period: 300
      EvaluationPeriods: 6
      Threshold: 0
      AlarmActions: [ !Ref AgentScaleDownPolicy ]
      Dimensions:
        - Name: Queue
          Value: !Ref BuildkiteQueue
      ComparisonOperator: LessThanOrEqualToThreshold

