file:
  /etc/buildkite-agent/buildkite-agent.cfg:
    exists: true

  /etc/buildkite-agent/hooks:
    filetype: directory
    exists: true
    owner: buildkite-agent
    group: buildkite-agent

  /var/lib/buildkite-agent/builds:
    filetype: directory
    exists: true
    owner: buildkite-agent
    group: buildkite-agent

  /var/lib/buildkite-agent/plugins:
    filetype: directory
    exists: true
    owner: buildkite-agent
    group: buildkite-agent

  /usr/local/bin/stop-agent-gracefully:
    exists: true
    mode: "0755"

port:
  tcp:22:
    listening: true
    ip:
    - 0.0.0.0

  tcp6:22:
    listening: true
    ip:
    - '::'

service:
  amazon-cloudwatch-agent:
    enabled: true
    running: true

  docker:
    enabled: true
    running: true

  lifecycled:
    enabled: true
    running: true

  sshd:
    enabled: true
    running: true

  buildkite-agent:
    enabled: true
    running: true

user:
  buildkite-agent:
    exists: true
    uid: 2000
    gid: 2000
    groups:
    - buildkite-agent
    - docker
    home: /var/lib/buildkite-agent
    shell: /bin/bash

  sshd:
    exists: true
    uid: 74
    gid: 74
    groups:
    - sshd
    home: /usr/share/empty.sshd
    shell: /sbin/nologin

group:
  buildkite-agent:
    exists: true
    gid: 2000

  docker:
    exists: true
    gid: 993

  sshd:
    exists: true
    gid: 74

process:
  buildkite-agent:
    running: true

  lifecycled:
    running: true

  sshd:
    running: true

command:
  aws --version:
    exit-status: 0

  git --version:
    exit-status: 0

  git-lfs --version:
    exit-status: 0

  systemctl is-enabled docker-gc.timer:
    exit-status: 0

  /usr/local/bin/docker-gc:
    exit-status: 0

  systemctl is-enabled docker-low-disk-gc.timer:
    exit-status: 0

  /usr/local/bin/docker-low-disk-gc:
    exit-status: 0

  # Check docker userns is enabled
  docker info --format='{{ `{{range .SecurityOptions}}{{if eq . "name=userns"}}{{"success"}}{{end}}{{end}}` }}':
    exit-status: 0
    stdout:
    - success
    timeout: 30000 # it can take some time for the daemon to start

  # Check docker plugins are installed
  docker info --format=$'{{ `{{range .ClientInfo.Plugins}}{{if eq .Name "buildx"}}success\n{{end}}{{if eq .Name "compose" }}success{{end}}{{end}}` }}':
    exit-status: 0
    stdout:
    - success
    - success
    timeout: 30000 # it can take some time for the daemon to start

  # Check that docker containers can run
  docker run --rm -v /var/run/docker.sock:/var/run/docker.sock docker:latest version:
    exit-status: 0
    timeout: 30000 # it can take some time to download the image

  # Check that userns allows writing as buildkite-agent
  sh -c 'docker run --rm -v "$PWD:/pwd" alpine:latest touch /pwd/test && stat -c %U:%G test' && rm test:
    exit-status: 0
    timeout: 30000 # it can take some time to download the image
    stdout:
    - buildkite-agent:docker
